<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Device Stats Comparison</title>
  <link rel="icon" href="icon.png" type="image/png">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; color: #222; }
    header { display: flex; justify-content: space-between; align-items: center; }
    .lang-select { position: relative; display: inline-block; }
    .lang-select select { background: #222; color: #fff; padding: 5px; border-radius: 5px; }
    .controls { margin: 20px 0; display: flex; gap: 20px; align-items: center; }
    .chart-container { width: 100%; max-width: 900px; margin: auto; }
    label { font-weight: bold; margin-right: 10px; }
  </style>
</head>
<body>
  <header>
    <h1 id="title">Device Stats Comparison</h1>
    <div class="lang-select">
      <select id="languageSwitcher">
        <option value="en" data-flag="🇬🇧">🇬🇧 English</option>
        <option value="ru" data-flag="🇷🇺">🇷🇺 Русский</option>
        <option value="uk" data-flag="🇺🇦">🇺🇦 Українська</option>
      </select>
    </div>
  </header>

  <div class="controls">
    <div>
      <label for="modelSelect" id="modelLabel">Select models:</label>
      <select id="modelSelect" multiple size="5"></select>
    </div>
    <div>
      <label for="metricSelect" id="metricLabel">Compare by:</label>
      <select id="metricSelect">
        <option value="avg">Average</option>
        <option value="min">Minimum</option>
        <option value="max">Maximum</option>
      </select>
    </div>
  </div>

  <div class="chart-container">
    <canvas id="statsChart"></canvas>
  </div>

  <script>
    const apiUrl = "https://script.google.com/macros/s/AKfycbzoKPI_Nf_xEzwK5r5iafhcxeVzz6DViK3nc65jrujXsb2N9Di10aNED6EeNccrD_2v7w/exec";

    const translations = {
      en: { title: "Device Stats Comparison", modelLabel: "Select models:", metricLabel: "Compare by:", avg: "Average", min: "Minimum", max: "Maximum" },
      ru: { title: "Сравнение статистики устройств", modelLabel: "Выберите модели:", metricLabel: "Сравнивать по:", avg: "Среднее", min: "Минимум", max: "Максимум" },
      uk: { title: "Порівняння статистики пристроїв", modelLabel: "Оберіть моделі:", metricLabel: "Порівнювати за:", avg: "Середнє", min: "Мінімум", max: "Максимум" }
    };

    const langSwitcher = document.getElementById("languageSwitcher");
    const titleEl = document.getElementById("title");
    const modelLabel = document.getElementById("modelLabel");
    const metricLabel = document.getElementById("metricLabel");
    const metricSelect = document.getElementById("metricSelect");
    const modelSelect = document.getElementById("modelSelect");
    const ctx = document.getElementById("statsChart").getContext("2d");

    let chart;

    function setLanguage(lang) {
      const t = translations[lang];
      titleEl.textContent = t.title;
      modelLabel.textContent = t.modelLabel;
      metricLabel.textContent = t.metricLabel;
      metricSelect.options[0].textContent = t.avg;
      metricSelect.options[1].textContent = t.min;
      metricSelect.options[2].textContent = t.max;
    }

    function detectLanguage() {
      const userLang = navigator.language.slice(0,2);
      if (translations[userLang]) return userLang;
      return "en";
    }

    langSwitcher.addEventListener("change", () => {
      setLanguage(langSwitcher.value);
      updateChart();
    });

    async function loadModels() {
      const res = await fetch(apiUrl + "?modelsOnly=true");
      const data = await res.json();
      modelSelect.innerHTML = "";
      data.models.forEach(model => {
        const opt = document.createElement("option");
        opt.value = model;
        opt.textContent = model;
        if (model === "Balance 2") opt.selected = true;
        modelSelect.appendChild(opt);
      });
      updateChart();
    }

    async function fetchStats(models, metric) {
      const res = await fetch(apiUrl + "?deviceName=" + models.join(","));
      const data = await res.json();
      let result = {};
      models.forEach(model => {
        if (data[model]) {
          result[model] = {};
          for (let key in data[model]) {
            if (key !== "count") {
              result[model][key] = data[model][key][metric];
            } else {
              result[model][key] = data[model][key];
            }
          }
        }
      });
      return result;
    }

    async function updateChart() {
      const selectedModels = Array.from(modelSelect.selectedOptions).map(o => o.value);
      const metric = metricSelect.value;
      if (!selectedModels.length) return;

      const stats = await fetchStats(selectedModels, metric);
      const labels = Object.keys(stats[selectedModels[0]]).filter(k => k !== "count");

      const datasets = Object.keys(stats).map((model, idx) => {
        return {
          label: model + " (n=" + stats[model].count + ")",
          data: labels.map(k => stats[model][k]),
          backgroundColor: `hsl(${idx * 60}, 70%, 50%)`
        };
      });

      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: "bar",
        data: { labels, datasets },
        options: {
          responsive: true,
          plugins: { legend: { position: "top" } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    modelSelect.addEventListener("change", updateChart);
    metricSelect.addEventListener("change", updateChart);

    // init
    const userLang = detectLanguage();
    langSwitcher.value = userLang;
    setLanguage(userLang);
    loadModels();
  </script>
</body>
</html>
