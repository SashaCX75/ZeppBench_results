<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Device Test Statistics</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <style>
    :root { --accent:#07c; }

    body {
      font-family: Inter, system-ui, Segoe UI, Roboto, Arial;
      margin: 0; padding: 24px;
      transition: background .3s, color .3s;
    }
    body.dark {
      background: linear-gradient(180deg,#071029 0%, #071b2b 100%);
      color: #e6eef8;
    }
    body.light {
      background: #f5f7fb;
      color: #1e293b;
    }

    .container {max-width: 980px; margin: auto;}

    /* ===== HEADER ===== */
    header {
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom:18px;
    }
    .logo {display:flex; align-items:center; gap:12px;}
    .brand {font-weight:700; font-size:20px;}
    .icon {
      width:48px; height:48px;
      border-radius:10px;
      background:linear-gradient(135deg,#007acc,#00c4ff);
      display:grid; place-items:center;
      box-shadow:0 6px 18px rgba(0,0,0,.5);
      font-size:22px; font-weight:bold;
      color:white;
    }
    .top-actions {
      margin-left:auto;
      display:flex;
      gap:12px;
      align-items:center;
    }
    .theme-toggle {cursor:pointer; font-size:20px;}

    /* ===== BLOCKS ===== */
    .card {
      background: rgba(0,0,0,0.1);
      padding:16px;
      border-radius:12px;
      margin-bottom:16px;
    }
    body.light .card {background:#fff; border:1px solid #ddd;}
    body.dark .card {background:#0b1220; border:1px solid rgba(255,255,255,.08);}

    h3 {margin-top:0;}
    .radio-group {display:flex; gap:12px;}

    /* ===== MODELS ===== */
    .models-list {
      display:grid;
      grid-template-columns: repeat(auto-fill,minmax(220px,1fr));
      gap:6px;
      max-height:260px;
      overflow-y:auto;
    }
    .models-list label {
      display:flex;
      align-items:flex-start;
      gap:8px;
      padding:6px;
      border-radius:6px;
      cursor:pointer;
      background:rgba(255,255,255,0.04);
      transition:background .2s;
      font-size:14px;
    }
    .models-list label:hover {background:rgba(255,255,255,0.1);}
    .models-list span {font-weight:500;}
    .models-list small {opacity:0.75; font-size:12px; display:block;}
    .models-list input {margin-top:3px;}

    /* ===== FOOTER ===== */
    .footer {
      text-align:center;
      margin-top:24px;
      font-size:13px;
      opacity:0.7;
    }
  </style>
</head>
<body class="dark">
<div class="container">

  <!-- Header -->
  <header>
    <div class="logo">
      <div class="icon">Œî</div>
      <div>
        <div class="brand" id="title">Device Test Statistics</div>
        <div class="muted" id="subtitle">Live aggregated metrics from Google Sheets</div>
      </div>
    </div>
    <div class="top-actions">
      <span class="theme-toggle" id="themeToggle" title="Toggle theme">üåô</span>
      <label for="lang">üåê</label>
      <select id="lang">
        <option value="en">English</option>
        <option value="ru">–†—É—Å—Å–∫–∏–π</option>
        <option value="uk">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
      </select>
    </div>
  </header>

  <!-- Sort -->
  <section class="card">
    <h3 id="sortHeading">Model sorting</h3>
    <div class="radio-group" id="sortGroup">
      <label><input type="radio" name="sort" value="name" checked> <span id="sortName">By name</span></label>
      <label><input type="radio" name="sort" value="countDesc"> <span id="sortDesc">By test count (‚Üì)</span></label>
      <label><input type="radio" name="sort" value="countAsc"> <span id="sortAsc">By test count (‚Üë)</span></label>
    </div>
  </section>

  <!-- Models -->
  <section class="card">
    <h3 id="modelsHeading">Select models</h3>
    <div class="models-list" id="modelsContainer"></div>
  </section>

  <!-- Metric -->
  <section class="card">
    <h3 id="metricHeading">Comparison type</h3>
    <div class="radio-group" id="metricGroup">
      <label><input type="radio" name="metric" value="min"> <span id="metricMin">Minimum values</span></label>
      <label><input type="radio" name="metric" value="avg" checked> <span id="metricAvg">Average values</span></label>
      <label><input type="radio" name="metric" value="max"> <span id="metricMax">Maximum values</span></label>
    </div>
  </section>

  <!-- Chart -->
  <section class="card">
    <h3 id="chartHeading">Histogram</h3>
    <div id="chartContainer">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </section>

  <!-- Footer -->
  <div class="footer" id="footer">
    Powered by Google Sheets ‚Ä¢ Data shown only for <strong>prod</strong> mode.
  </div>
</div>

<script>
const SCRIPT_ID="AKfycbym44b2BGJkK01Dq3d6tL0VRB_q-_vOq1FMmHuIJvzdhW2nrE6170-emrlNhe140xmEug";
const BASE="https://script.google.com/macros/s/"+SCRIPT_ID+"/exec";

const modelContainer=document.getElementById("modelsContainer");
const sortGroup=document.getElementById("sortGroup");
const metricGroup=document.getElementById("metricGroup");
const chartContainer=document.getElementById("chartContainer");
const themeToggle=document.getElementById("themeToggle");
const langSelect=document.getElementById("lang");

let cache={}, chart;

// ===== TRANSLATIONS =====
const t={
  en:{
    sortHeading:"Model sorting", sortName:"By name", sortDesc:"By test count (‚Üì)", sortAsc:"By test count (‚Üë)",
    modelsHeading:"Select models",
    metricHeading:"Comparison type", metricMin:"Minimum values", metricAvg:"Average values", metricMax:"Maximum values",
    chartHeading:"Histogram"
  },
  ru:{
    sortHeading:"–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –º–æ–¥–µ–ª–µ–π", sortName:"–ü–æ –∏–º–µ–Ω–∏", sortDesc:"–ü–æ —á–∏—Å–ª—É —Ç–µ—Å—Ç–æ–≤ (‚Üì)", sortAsc:"–ü–æ —á–∏—Å–ª—É —Ç–µ—Å—Ç–æ–≤ (‚Üë)",
    modelsHeading:"–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª–∏",
    metricHeading:"–¢–∏–ø —Å—Ä–∞–≤–Ω–µ–Ω–∏—è", metricMin:"–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è", metricAvg:"–°—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è", metricMax:"–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è",
    chartHeading:"–ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞"
  },
  uk:{
    sortHeading:"–°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –º–æ–¥–µ–ª–µ–π", sortName:"–ó–∞ –Ω–∞–∑–≤–æ—é", sortDesc:"–ó–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—é —Ç–µ—Å—Ç—ñ–≤ (‚Üì)", sortAsc:"–ó–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—é —Ç–µ—Å—Ç—ñ–≤ (‚Üë)",
    modelsHeading:"–û–±–µ—Ä—ñ—Ç—å –º–æ–¥–µ–ª—ñ",
    metricHeading:"–¢–∏–ø –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è", metricMin:"–ú—ñ–Ω—ñ–º–∞–ª—å–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è", metricAvg:"–°–µ—Ä–µ–¥–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è", metricMax:"–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è",
    chartHeading:"–ì—ñ—Å—Ç–æ–≥—Ä–∞–º–∞"
  }
};

function applyLang(){
  const lang=langSelect.value;
  document.getElementById("sortHeading").textContent=t[lang].sortHeading;
  document.getElementById("sortName").textContent=t[lang].sortName;
  document.getElementById("sortDesc").textContent=t[lang].sortDesc;
  document.getElementById("sortAsc").textContent=t[lang].sortAsc;
  document.getElementById("modelsHeading").textContent=t[lang].modelsHeading;
  document.getElementById("metricHeading").textContent=t[lang].metricHeading;
  document.getElementById("metricMin").textContent=t[lang].metricMin;
  document.getElementById("metricAvg").textContent=t[lang].metricAvg;
  document.getElementById("metricMax").textContent=t[lang].metricMax;
  document.getElementById("chartHeading").textContent=t[lang].chartHeading;
}

// ===== LOCAL STORAGE =====
function savePrefs(){
  const models=getSelectedModels();
  localStorage.setItem("theme",document.body.classList.contains("light")?"light":"dark");
  localStorage.setItem("lang",langSelect.value);
  localStorage.setItem("metric",metricGroup.querySelector("input:checked").value);
  localStorage.setItem("models",JSON.stringify(models));
}
function loadPrefs(){
  const theme=localStorage.getItem("theme");
  if(theme){
    document.body.classList.remove("light","dark");
    document.body.classList.add(theme);
    themeToggle.textContent=theme==="light"?"‚òÄÔ∏è":"üåô";
  }
  const lang=localStorage.getItem("lang");
  if(lang) langSelect.value=lang;
  applyLang();
}

// ===== THEME =====
themeToggle.addEventListener("click",()=>{
  document.body.classList.toggle("light");
  document.body.classList.toggle("dark");
  themeToggle.textContent=document.body.classList.contains("light")?"‚òÄÔ∏è":"üåô";
  savePrefs();
  if(chart) chart.update();
});

// ===== MODELS =====
async function loadModels(){
  chartContainer.textContent="–ó–∞–≥—Ä—É–∑–∫–∞...";
  const res=await fetch(BASE+"?modelsOnly=true");
  const j=await res.json();
  let models=j.models||[];

  const sortVal=sortGroup.querySelector("input:checked").value;
  if(sortVal==="name") models.sort((a,b)=>a.name.localeCompare(b.name));
  if(sortVal==="countDesc") models.sort((a,b)=>b.count-a.count);
  if(sortVal==="countAsc") models.sort((a,b)=>a.count-b.count);

  modelContainer.innerHTML="";
  models.forEach(({name,count})=>{
    const lbl=document.createElement("label");
    const chk=document.createElement("input");
    chk.type="checkbox"; chk.value=name;
    lbl.appendChild(chk);
    const wrap=document.createElement("div");
    const span=document.createElement("span");
    span.textContent=name;
    const small=document.createElement("small");
    small.textContent=`(—á–∏—Å–ª–æ —Ç–µ—Å—Ç–æ–≤: ${count})`;
    wrap.appendChild(span);
    wrap.appendChild(small);
    lbl.appendChild(wrap);
    modelContainer.appendChild(lbl);
  });

  // Restore selection
  const savedModels=JSON.parse(localStorage.getItem("models")||"[]");
  if(savedModels.length){
    savedModels.forEach(sm=>{
      const cb=modelContainer.querySelector(`input[value="${sm}"]`);
      if(cb) cb.checked=true;
    });
  } else {
    const boxes=modelContainer.querySelectorAll("input[type=checkbox]");
    if(boxes.length){
      boxes[0].checked=true;
      boxes.forEach(b=>{if(b.value==="Balance 2") b.checked=true;});
    }
  }

  refreshChart();
}

function getSelectedModels(){
  return Array.from(modelContainer.querySelectorAll("input:checked")).map(c=>c.value).slice(0,6);
}

async function fetchModelStats(model){
  if(cache[model]) return cache[model];
  const res=await fetch(BASE+"?deviceName="+encodeURIComponent(model));
  const j=await res.json();
  const s=j.stats&&j.stats[model];
  cache[model]=s||null;
  return cache[model];
}

// ===== CHART =====
async function refreshChart(){
  const models=getSelectedModels();
  if(models.length<2){chartContainer.textContent="–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã 2 –º–æ–¥–µ–ª–∏";return;}
  chartContainer.textContent="–ó–∞–≥—Ä—É–∑–∫–∞...";

  const metric=metricGroup.querySelector("input:checked").value;
  const labels=["Canvas","CanvasText","Widget","Widget2","Math","LS","ES","ES BF"];
  const keys=["canvas","canvasText","widget","widget2","math","ls","es","esBf"];

  // –¶–≤–µ—Ç–∞ –ø–æ–¥ —Ç–µ–º—É
  const lightColors=["#1565c0","#ad1457","#ef6c00","#2e7d32","#c2185b","#6a1b9a","#0277bd","#d84315"];
  const darkColors=["#42a5f5","#f06292","#ffb74d","#81c784","#f48fb1","#ba68c8","#64b5f6","#ff8a65"];
  const colors=document.body.classList.contains("light")?lightColors:darkColors;

  const dataByModel={};
  for(const model of models){
    const stats=await fetchModelStats(model);
    if(!stats) continue;
    dataByModel[model]=keys.map(k=>stats[k]?stats[k][metric]:0);
  }

  const modelNames=Object.keys(dataByModel);
  if(!modelNames.length){chartContainer.textContent="–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö";return;}

  // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –∫–∞–∂–¥–æ–º—É –ø–∞—Ä–∞–º–µ—Ç—Ä—É
  const maxPerKey=keys.map((_,i)=>Math.max(...modelNames.map(m=>dataByModel[m][i]||0)));
  const normalizedByModel={};
  modelNames.forEach(m=>{
    normalizedByModel[m]=dataByModel[m].map((v,i)=>maxPerKey[i]?v/maxPerKey[i]*100:0);
  });

  const datasets=modelNames.map((m,i)=>({
    label:m,
    data:normalizedByModel[m],
    backgroundColor:colors[i%colors.length],
    barThickness:12
  }));

  chartContainer.innerHTML='<canvas id="chart"></canvas>';
  const ctx=document.getElementById("chart").getContext("2d");
  if(chart) chart.destroy();
  chart=new Chart(ctx,{
    type:"bar",
    data:{labels:labels,datasets:datasets},
    options:{
      indexAxis:"y",
      responsive:true,
      plugins:{
        legend:{position:"bottom"},
        tooltip:{
          callbacks:{
            label:(ctx)=>{
              const v=ctx.raw;
              return v.toFixed(1)+"%";
            }
          }
        },
        datalabels:{
          anchor:"end",
          align:"start",
          color:document.body.classList.contains("light")?"#000":"#fff",
          formatter:v=>v.toFixed(1)+"%"
        }
      },
      scales:{
        x:{
          beginAtZero:true,
          max:100,
          ticks:{display:false}
        }
      }
    },
    plugins:[ChartDataLabels]
  });

  savePrefs();
}

// ===== EVENTS =====
sortGroup.addEventListener("change",()=>{loadModels(); savePrefs();});
metricGroup.addEventListener("change",()=>{refreshChart(); savePrefs();});
modelContainer.addEventListener("change",()=>{refreshChart(); savePrefs();});
langSelect.addEventListener("change",()=>{applyLang(); savePrefs();});

// ===== INIT =====
loadPrefs();
loadModels();
</script>
</body>
</html>
