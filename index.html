<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Device Stats Comparison</title>
  <link rel="icon" href="icon.png" type="image/png">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; color: #222; transition: background 0.3s, color 0.3s; }
    header { display: flex; justify-content: space-between; align-items: center; }
    .lang-select { position: relative; display: inline-block; }
    .lang-select select { background: #222; color: #fff; padding: 5px; border-radius: 5px; }
    .controls { margin: 20px 0; display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
    .chart-container { width: 100%; max-width: 900px; margin: auto; }
    label { font-weight: bold; margin-right: 10px; }
    .theme-toggle { cursor: pointer; padding: 5px 10px; border: 1px solid #ccc; border-radius: 5px; background: #eee; }
    .message { margin: 20px 0; font-weight: bold; color: crimson; text-align: center; }
    body.dark { background: #222; color: #eee; }
    body.dark .lang-select select { background: #444; color: #fff; }
    body.dark .theme-toggle { background: #444; color: #fff; border-color: #666; }
  </style>
</head>
<body>
  <header>
    <h1 id="title">Device Stats Comparison</h1>
    <div style="display:flex; gap:10px; align-items:center;">
      <div class="lang-select">
        <select id="languageSwitcher">
          <option value="en" data-flag="üá¨üáß">üá¨üáß English</option>
          <option value="ru" data-flag="üá∑üá∫">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
          <option value="uk" data-flag="üá∫üá¶">üá∫üá¶ –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
        </select>
      </div>
      <button id="themeToggle" class="theme-toggle">üåô Dark</button>
    </div>
  </header>

  <div class="controls">
    <div>
      <label for="modelSelect" id="modelLabel">Select models:</label>
      <select id="modelSelect" multiple size="5"></select>
    </div>
    <div>
      <label for="metricSelect" id="metricLabel">Compare by:</label>
      <select id="metricSelect">
        <option value="avg">Average</option>
        <option value="min">Minimum</option>
        <option value="max">Maximum</option>
      </select>
    </div>
  </div>

  <div id="message" class="message" style="display:none;"></div>

  <div class="chart-container">
    <canvas id="statsChart"></canvas>
  </div>

  <script>
    const apiUrl = "https://script.google.com/macros/s/AKfycbzoKPI_Nf_xEzwK5r5iafhcxeVzz6DViK3nc65jrujXsb2N9Di10aNED6EeNccrD_2v7w/exec";

    const translations = {
      en: { title: "Device Stats Comparison", modelLabel: "Select models:", metricLabel: "Compare by:", avg: "Average", min: "Minimum", max: "Maximum", noData: "No data available for selected models." },
      ru: { title: "–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤", modelLabel: "–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª–∏:", metricLabel: "–°—Ä–∞–≤–Ω–∏–≤–∞—Ç—å –ø–æ:", avg: "–°—Ä–µ–¥–Ω–µ–µ", min: "–ú–∏–Ω–∏–º—É–º", max: "–ú–∞–∫—Å–∏–º—É–º", noData: "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π." },
      uk: { title: "–ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤", modelLabel: "–û–±–µ—Ä—ñ—Ç—å –º–æ–¥–µ–ª—ñ:", metricLabel: "–ü–æ—Ä—ñ–≤–Ω—é–≤–∞—Ç–∏ –∑–∞:", avg: "–°–µ—Ä–µ–¥–Ω—î", min: "–ú—ñ–Ω—ñ–º—É–º", max: "–ú–∞–∫—Å–∏–º—É–º", noData: "–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –æ–±—Ä–∞–Ω–∏—Ö –º–æ–¥–µ–ª–µ–π." }
    };

    const langSwitcher = document.getElementById("languageSwitcher");
    const titleEl = document.getElementById("title");
    const modelLabel = document.getElementById("modelLabel");
    const metricLabel = document.getElementById("metricLabel");
    const metricSelect = document.getElementById("metricSelect");
    const modelSelect = document.getElementById("modelSelect");
    const ctx = document.getElementById("statsChart").getContext("2d");
    const themeToggle = document.getElementById("themeToggle");
    const messageEl = document.getElementById("message");

    let chart;
    let currentLang = "en";

    function setLanguage(lang) {
      const t = translations[lang];
      if (!t) return;
      currentLang = lang;
      titleEl.textContent = t.title;
      modelLabel.textContent = t.modelLabel;
      metricLabel.textContent = t.metricLabel;
      metricSelect.options[0].textContent = t.avg;
      metricSelect.options[1].textContent = t.min;
      metricSelect.options[2].textContent = t.max;
    }

    function detectLanguage() {
      const userLang = navigator.language.slice(0,2);
      if (translations[userLang]) return userLang;
      return "en";
    }

    langSwitcher.addEventListener("change", () => {
      setLanguage(langSwitcher.value);
      updateChart();
    });

    themeToggle.addEventListener("click", () => {
      document.body.classList.toggle("dark");
      themeToggle.textContent = document.body.classList.contains("dark") ? "‚òÄÔ∏è Light" : "üåô Dark";
    });

    async function loadModels() {
      const res = await fetch(apiUrl + "?modelsOnly=true");
      const data = await res.json();
      modelSelect.innerHTML = "";
      if (!data.models) return;
      data.models.forEach(model => {
        const opt = document.createElement("option");
        opt.value = model;
        opt.textContent = model;
        if (model === "Balance 2") opt.selected = true;
        modelSelect.appendChild(opt);
      });
      updateChart();
    }

    async function fetchStats(models, metric) {
      const res = await fetch(apiUrl + "?deviceName=" + models.join(","));
      const data = await res.json();
      let result = {};
      models.forEach(model => {
        if (data[model]) {
          result[model] = {};
          for (let key in data[model]) {
            if (key !== "count") {
              result[model][key] = data[model][key][metric];
            } else {
              result[model][key] = data[model][key];
            }
          }
        }
      });
      return result;
    }

    async function updateChart() {
      const selectedModels = Array.from(modelSelect.selectedOptions).map(o => o.value);
      const metric = metricSelect.value;
      if (!selectedModels.length) return;

      const stats = await fetchStats(selectedModels, metric);
      if (!stats || Object.keys(stats).length === 0) {
        messageEl.style.display = "block";
        messageEl.textContent = translations[currentLang].noData;
        if (chart) chart.destroy();
        return;
      }
      messageEl.style.display = "none";

      const labels = Object.keys(stats[selectedModels[0]]).filter(k => k !== "count");

      const datasets = Object.keys(stats).map((model, idx) => {
        return {
          label: model + " (n=" + stats[model].count + ")",
          data: labels.map(k => stats[model][k]),
          backgroundColor: `hsl(${idx * 60}, 70%, 50%)`
        };
      });

      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: "bar",
        data: { labels, datasets },
        options: {
          responsive: true,
          plugins: { legend: { position: "top" } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    modelSelect.addEventListener("change", updateChart);
    metricSelect.addEventListener("change", updateChart);

    // init
    const userLang = detectLanguage();
    langSwitcher.value = userLang;
    setLanguage(userLang);
    loadModels();
  </script>
</body>
</html>
