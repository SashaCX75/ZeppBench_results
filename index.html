<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Device Stats Comparison</title>
  <link rel="icon" href="icon.png" type="image/png">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; color: #222; transition: background 0.3s, color 0.3s; }
    header { display: flex; justify-content: space-between; align-items: center; }
    .lang-select { position: relative; display: inline-flex; align-items: center; gap: 8px; }
    .lang-select select { background: #eee; color: #222; padding: 5px; border-radius: 5px; }
    .lang-flag { font-size: 1.4em; }
    .controls { margin: 20px 0; display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
    .chart-container { width: 100%; max-width: 900px; margin: auto; }
    label { font-weight: normal; margin-right: 10px; }
    .theme-toggle { display: none; }
    .message { margin: 20px 0; font-weight: bold; color: crimson; text-align: center; }
    .radio-group { display: flex; gap: 15px; align-items: center; }
    .model-pair { display: flex; flex-direction: column; gap: 10px; }
  </style>
</head>
<body>
  <header>
    <h1 id="title">Device Stats Comparison</h1>
    <div style="display:flex; gap:10px; align-items:center;">
      <div class="lang-select">
        <select id="languageSwitcher">
          <option value="en">English</option>
          <option value="ru">–†—É—Å—Å–∫–∏–π</option>
          <option value="uk">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
        </select>
        <span id="langFlag" class="lang-flag">üá¨üáß</span>
      </div>
    </div>
  </header>

  <div class="controls">
    <div class="model-pair">
      <label id="modelLabel1">Model 1:</label>
      <select id="modelSelect1"></select>
      <label id="modelLabel2">Model 2:</label>
      <select id="modelSelect2"></select>
    </div>
    <div>
      <label id="metricLabel">Compare by:</label>
      <div class="radio-group">
        <label><input type="radio" name="metric" value="avg" checked> <span id="avgLabel">Average</span></label>
        <label><input type="radio" name="metric" value="min"> <span id="minLabel">Minimum</span></label>
        <label><input type="radio" name="metric" value="max"> <span id="maxLabel">Maximum</span></label>
      </div>
    </div>
  </div>

  <div id="message" class="message" style="display:none;"></div>

  <div class="chart-container">
    <canvas id="statsChart"></canvas>
  </div>

  <script>
    const apiUrl = "https://script.google.com/macros/s/AKfycbzoKPI_Nf_xEzwK5r5iafhcxeVzz6DViK3nc65jrujXsb2N9Di10aNED6EeNccrD_2v7w/exec";
    const cacheDuration = 10 * 60 * 1000; // –∫—ç—à 10 –º–∏–Ω—É—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    const cache = {};

    const translations = {
      en: { title: "Device Stats Comparison", modelLabel1: "Model 1:", modelLabel2: "Model 2:", metricLabel: "Compare by:", avg: "Average", min: "Minimum", max: "Maximum", noData: "No data available for selected models.", flag: "üá¨üáß" },
      ru: { title: "–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤", modelLabel1: "–ú–æ–¥–µ–ª—å 1:", modelLabel2: "–ú–æ–¥–µ–ª—å 2:", metricLabel: "–°—Ä–∞–≤–Ω–∏–≤–∞—Ç—å –ø–æ:", avg: "–°—Ä–µ–¥–Ω–µ–µ", min: "–ú–∏–Ω–∏–º—É–º", max: "–ú–∞–∫—Å–∏–º—É–º", noData: "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π.", flag: "üá∑üá∫" },
      uk: { title: "–ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤", modelLabel1: "–ú–æ–¥–µ–ª—å 1:", modelLabel2: "–ú–æ–¥–µ–ª—å 2:", metricLabel: "–ü–æ—Ä—ñ–≤–Ω—é–≤–∞—Ç–∏ –∑–∞:", avg: "–°–µ—Ä–µ–¥–Ω—î", min: "–ú—ñ–Ω—ñ–º—É–º", max: "–ú–∞–∫—Å–∏–º—É–º", noData: "–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –æ–±—Ä–∞–Ω–∏—Ö –º–æ–¥–µ–ª–µ–π.", flag: "üá∫üá¶" }
    };

    const langSwitcher = document.getElementById("languageSwitcher");
    const langFlag = document.getElementById("langFlag");
    const titleEl = document.getElementById("title");
    const modelLabel1 = document.getElementById("modelLabel1");
    const modelLabel2 = document.getElementById("modelLabel2");
    const metricLabel = document.getElementById("metricLabel");
    const avgLabel = document.getElementById("avgLabel");
    const minLabel = document.getElementById("minLabel");
    const maxLabel = document.getElementById("maxLabel");
    const modelSelect1 = document.getElementById("modelSelect1");
    const modelSelect2 = document.getElementById("modelSelect2");
    const ctx = document.getElementById("statsChart").getContext("2d");
    const messageEl = document.getElementById("message");

    let chart;
    let currentLang = "en";

    function setLanguage(lang) {
      const t = translations[lang];
      if (!t) return;
      currentLang = lang;
      titleEl.textContent = t.title;
      modelLabel1.textContent = t.modelLabel1;
      modelLabel2.textContent = t.modelLabel2;
      metricLabel.textContent = t.metricLabel;
      avgLabel.textContent = t.avg;
      minLabel.textContent = t.min;
      maxLabel.textContent = t.max;
      langFlag.textContent = t.flag;
    }

    function detectLanguage() {
      const userLang = navigator.language.slice(0,2);
      if (translations[userLang]) return userLang;
      return "en";
    }

    langSwitcher.addEventListener("change", () => {
      setLanguage(langSwitcher.value);
      updateChart();
    });

    async function loadModels() {
      const res = await fetch(apiUrl + "?modelsOnly=true");
      const data = await res.json();
      modelSelect1.innerHTML = "";
      modelSelect2.innerHTML = "";
      if (!data.models) return;
      data.models.forEach(model => {
        const opt1 = document.createElement("option");
        opt1.value = model;
        opt1.textContent = model;
        if (model === "Balance 2") opt1.selected = true;
        modelSelect1.appendChild(opt1);

        const opt2 = document.createElement("option");
        opt2.value = model;
        opt2.textContent = model;
        if (model === "Balance 2") opt2.selected = true;
        modelSelect2.appendChild(opt2);
      });
      updateChart();
    }

    async function fetchSingleModel(model, metric) {
      const now = Date.now();
      if (cache[model] && (now - cache[model].time < cacheDuration)) {
        return cache[model].data;
      }
      const res = await fetch(apiUrl + "?deviceName=" + encodeURIComponent(model));
      const data = await res.json();
      if (!data[model]) return null;
      let result = {};
      for (let key in data[model]) {
        if (key !== "count") {
          result[key] = data[model][key][metric];
        } else {
          result[key] = data[model][key];
        }
      }
      cache[model] = { data: { [model]: result }, time: now };
      return cache[model].data;
    }

    async function fetchStats(models, metric) {
      let result = {};
      for (const model of models) {
        const modelData = await fetchSingleModel(model, metric);
        if (modelData) Object.assign(result, modelData);
      }
      return result;
    }

    async function updateChart() {
      const model1 = modelSelect1.value;
      const model2 = modelSelect2.value;
      const metric = document.querySelector('input[name="metric"]:checked').value;
      if (!model1 || !model2) return;

      const stats = await fetchStats([model1, model2], metric);
      if (!stats || Object.keys(stats).length === 0) {
        messageEl.style.display = "block";
        messageEl.textContent = translations[currentLang].noData;
        if (chart) chart.destroy();
        return;
      }
      messageEl.style.display = "none";

      const labels = Object.keys(stats[model1] || stats[model2]).filter(k => k !== "count");

      const datasets = Object.keys(stats).map((model, idx) => ({
        label: model + " (n=" + stats[model].count + ")",
        data: labels.map(k => stats[model][k]),
        backgroundColor: `hsl(${idx * 180}, 70%, 50%)`
      }));

      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: "bar",
        data: { labels, datasets },
        options: {
          responsive: true,
          plugins: { legend: { position: "top" } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    modelSelect1.addEventListener("change", updateChart);
    modelSelect2.addEventListener("change", updateChart);
    document.querySelectorAll('input[name="metric"]').forEach(r => r.addEventListener("change", updateChart));

    // init
    const userLang = detectLanguage();
    langSwitcher.value = userLang;
    setLanguage(userLang);
    loadModels();
  </script>
