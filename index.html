<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Device Test Statistics</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <style>
    :root { --accent:#07c; }

    body {
      font-family: Inter, system-ui, Segoe UI, Roboto, Arial;
      margin: 0; padding: 24px;
      transition: background .3s, color .3s;
    }
    body.dark {
      background: linear-gradient(180deg,#071029 0%, #071b2b 100%);
      color: #e6eef8;
    }
    body.light {
      background: #f5f7fb;
      color: #1e293b;
    }

    .container {max-width: 980px; margin: auto;}

    /* ===== HEADER ===== */
    header {
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom:18px;
    }
    .logo {display:flex; align-items:center; gap:12px;}
    .brand {font-weight:700; font-size:20px;}
    .icon {
      width:48px; height:48px;
      border-radius:10px;
      background:linear-gradient(135deg,#007acc,#00c4ff);
      display:grid; place-items:center;
      box-shadow:0 6px 18px rgba(0,0,0,.5);
      font-size:22px; font-weight:bold;
      color:white;
    }
    .top-actions {
      margin-left:auto;
      display:flex;
      gap:12px;
      align-items:center;
    }
    .theme-toggle {cursor:pointer; font-size:20px;}

    /* ===== BLOCKS ===== */
    .card {
      background: rgba(0,0,0,0.1);
      padding:16px;
      border-radius:12px;
      margin-bottom:16px;
    }
    body.light .card {background:#fff; border:1px solid #ddd;}
    body.dark .card {background:#0b1220; border:1px solid rgba(255,255,255,.08);}

    h3 {margin-top:0;}
    .radio-group {display:flex; gap:12px;}

    /* ===== MODELS ===== */
    .models-list {
      display:grid;
      grid-template-columns: repeat(auto-fill,minmax(220px,1fr));
      gap:6px;
      max-height:260px;
      overflow-y:auto;
    }
    .models-list label {
      display:flex;
      align-items:flex-start;
      gap:8px;
      padding:6px;
      border-radius:6px;
      cursor:pointer;
      background:rgba(255,255,255,0.04);
      transition:background .2s;
      font-size:14px;
    }
    .models-list label:hover {background:rgba(255,255,255,0.1);}
    .models-list span {font-weight:500;}
    .models-list small {opacity:0.75; font-size:12px; display:block;}
    .models-list input {margin-top:3px;}

    /* ===== FOOTER ===== */
    .footer {
      text-align:center;
      margin-top:24px;
      font-size:13px;
      opacity:0.7;
    }
  </style>
</head>
<body class="dark">
<div class="container">

  <!-- Header -->
  <header>
    <div class="logo">
      <div class="icon">Œî</div>
      <div>
        <div class="brand" id="title">Device testing statistics in the ZeppBench app</div>
        <div class="muted" id="subtitle">Live aggregated metrics from Google Sheets</div>
      </div>
    </div>
    <div class="top-actions">
      <span class="theme-toggle" id="themeToggle" title="Toggle theme">üåô</span>
      <label for="lang">üåê</label>
      <select id="lang">
        <option value="en">English</option>
        <option value="ru">–†—É—Å—Å–∫–∏–π</option>
        <option value="uk">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
      </select>
    </div>
  </header>

  <!-- Sort -->
  <section class="card">
    <h3 id="sortHeading">Model sorting</h3>
    <div class="radio-group" id="sortGroup">
      <label><input type="radio" name="sort" value="name" checked> <span id="sortName">By name</span></label>
      <label><input type="radio" name="sort" value="countDesc"> <span id="sortDesc">By test count (‚Üì)</span></label>
      <label><input type="radio" name="sort" value="countAsc"> <span id="sortAsc">By test count (‚Üë)</span></label>
    </div>
  </section>

  <!-- Models -->
  <section class="card">
    <h3 id="modelsHeading">Select models</h3>
    <div class="models-list" id="modelsContainer"></div>
  </section>

  <!-- Metric -->
  <section class="card">
    <h3 id="metricHeading">Comparison type</h3>
    <div class="radio-group" id="metricGroup">
      <label><input type="radio" name="metric" value="min"> <span id="metricMin">Minimum values</span></label>
      <label><input type="radio" name="metric" value="avg" checked> <span id="metricAvg">Average values</span></label>
      <label><input type="radio" name="metric" value="max"> <span id="metricMax">Maximum values</span></label>
    </div>
  </section>

  <!-- Chart -->
  <section class="card">
    <h3 id="chartHeading">Histogram</h3>
    <div id="chartContainer">Loading...</div>
  </section>

  <!-- Footer -->
  <div class="footer" id="footer">
    Developed by SashaCX75 ‚Ä¢ Powered by Google Sheets.
  </div>
</div>

<script>
const SCRIPT_ID="AKfycbym44b2BGJkK01Dq3d6tL0VRB_q-_vOq1FMmHuIJvzdhW2nrE6170-emrlNhe140xmEug";
const BASE="https://script.google.com/macros/s/"+SCRIPT_ID+"/exec";

const modelContainer=document.getElementById("modelsContainer");
const sortGroup=document.getElementById("sortGroup");
const metricGroup=document.getElementById("metricGroup");
const chartContainer=document.getElementById("chartContainer");
const themeToggle=document.getElementById("themeToggle");
const langSelect=document.getElementById("lang");

let cache={}, chart;

// ===== TRANSLATIONS =====
const labelTranslations={
  en:["Canvas shape\ndrawing test","Canvas text\ndrawing test","Widget\ncreation test","Widget\ncreation test #2","Math\nfunctions test","LocalStorage\nread/write test","EasyStorage file\nread/write test","EasyStorage big file\nread/write test"],
  ru:["–¢–µ—Å—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏\n—Ä–∏—Å–æ–≤–∞–Ω–∏—è —Ñ–∏–≥—É—Ä\n–Ω–∞ —Ö–æ–ª—Å—Ç–µ","–¢–µ—Å—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏\n—Ä–∏—Å–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞\n–Ω–∞ —Ö–æ–ª—Å—Ç–µ","–¢–µ—Å—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏\n—Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–¥–∂–µ—Ç–æ–≤","–¢–µ—Å—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏\n—Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–¥–∂–µ—Ç–æ–≤ ‚Ññ2","–¢–µ—Å—Ç –≤—ã—á–∏—Å–ª–µ–Ω–∏—è\n–º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π","–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏\n—á—Ç–µ–Ω–∏—è/–∑–∞–ø–∏—Å–∏ –≤ localStorage","–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏\n—á—Ç–µ–Ω–∏—è/–∑–∞–ø–∏—Å–∏ —Ñ–∞–π–ª–æ–≤\n–≤ EasyStorage","–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏\n—á—Ç–µ–Ω–∏—è/–∑–∞–ø–∏—Å–∏ –±–æ–ª—å—à–∏—Ö\n—Ñ–∞–π–ª–æ–≤"],
  uk:["–¢–µ—Å—Ç —à–≤–∏–¥–∫–æ—Å—Ç—ñ\n–º–∞–ª—é–≤–∞–Ω–Ω—è —Ñ—ñ–≥—É—Ä\n–Ω–∞ canvas","–¢–µ—Å—Ç —à–≤–∏–¥–∫–æ—Å—Ç—ñ\n–º–∞–ª—é–≤–∞–Ω–Ω—è —Ç–µ–∫—Å—Ç—É\n–Ω–∞ canvas","–¢–µ—Å—Ç —à–≤–∏–¥–∫–æ—Å—Ç—ñ\n—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –≤—ñ–¥–∂–µ—Ç—ñ–≤","–¢–µ—Å—Ç —à–≤–∏–¥–∫–æ—Å—Ç—ñ\n—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –≤—ñ–¥–∂–µ—Ç—ñ–≤ ‚Ññ2","–¢–µ—Å—Ç –æ–±—á–∏—Å–ª–µ–Ω–Ω—è\n–º–∞—Ç–µ–º–∞—Ç–∏—á–Ω–∏—Ö —Ñ—É–Ω–∫—Ü—ñ–π","–¢–µ—Å—Ç —à–≤–∏–¥–∫–æ—Å—Ç—ñ\n—á–∏—Ç–∞–Ω–Ω—è/–∑–∞–ø–∏—Å—É –≤ localStorage","–¢–µ—Å—Ç —à–≤–∏–¥–∫–æ—Å—Ç—ñ\n—á–∏—Ç–∞–Ω–Ω—è/–∑–∞–ø–∏—Å—É —Ñ–∞–π–ª—ñ–≤\n–≤ EasyStorage","–¢–µ—Å—Ç —à–≤–∏–¥–∫–æ—Å—Ç—ñ\n—á–∏—Ç–∞–Ω–Ω—è/–∑–∞–ø–∏—Å—É –≤–µ–ª–∏–∫–∏—Ö\n—Ñ–∞–π–ª—ñ–≤"]
};
const t={
  en:{
    title:"Device testing statistics in the ZeppBench app", subtitle:"Live aggregated metrics from Google Sheets",
    sortHeading:"Model sorting", sortName:"By name", sortDesc:"By test count (‚Üì)", sortAsc:"By test count (‚Üë)",
    modelsHeading:"Select models", testCount: "number of tests",
    metricHeading:"Select which values to compare", metricMin:"Minimum values", metricAvg:"Average values", metricMax:"Maximum values",
    chartHeading:"Comparison results", chartContainer:"Loading...", noData:"No data", selectModels:"Select at least 2 models"
  },
  ru:{
    title:"–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ ZeppBench", subtitle:"–ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –∏–∑ Google Sheets",
    sortHeading:"–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –º–æ–¥–µ–ª–µ–π", sortName:"–ü–æ –∏–º–µ–Ω–∏", sortDesc:"–ü–æ —á–∏—Å–ª—É —Ç–µ—Å—Ç–æ–≤ (‚Üì)", sortAsc:"–ü–æ —á–∏—Å–ª—É —Ç–µ—Å—Ç–æ–≤ (‚Üë)",
    modelsHeading:"–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª–∏", testCount: "—á–∏—Å–ª–æ —Ç–µ—Å—Ç–æ–≤",
    metricHeading:"–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å", metricMin:"–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è", metricAvg:"–°—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è", metricMax:"–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è",
    chartHeading:"–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å—Ä–∞–≤–Ω–µ–Ω–∏—è", chartContainer:"–ó–∞–≥—Ä—É–∑–∫–∞...", noData:"–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö", selectModels:"–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã 2 –º–æ–¥–µ–ª–∏"
  },
  uk:{
    title:"–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤ —É –¥–æ–¥–∞—Ç–∫—É ZeppBench", subtitle:"–ê–≥—Ä–µ–≥–æ–≤–∞–Ω—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏ –≤ —Ä–µ–∂–∏–º—ñ —Ä–µ–∞–ª—å–Ω–æ–≥–æ —á–∞—Å—É –∑ Google Sheets",
    sortHeading:"–°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –º–æ–¥–µ–ª–µ–π", sortName:"–ó–∞ –Ω–∞–∑–≤–æ—é", sortDesc:"–ó–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—é —Ç–µ—Å—Ç—ñ–≤ (‚Üì)", sortAsc:"–ó–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—é —Ç–µ—Å—Ç—ñ–≤ (‚Üë)",
    modelsHeading:"–û–±–µ—Ä—ñ—Ç—å –º–æ–¥–µ–ª—ñ", testCount: "–∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–µ—Å—Ç—ñ–≤",
    metricHeading:"–í–∏–±–µ—Ä—ñ—Ç—å —è–∫—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –ø–æ—Ä—ñ–≤–Ω—é–≤–∞—Ç–∏", metricMin:"–ú—ñ–Ω—ñ–º–∞–ª—å–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è", metricAvg:"–°–µ—Ä–µ–¥–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è", metricMax:"–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è",
    chartHeading:"–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è", chartContainer:"–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...", noData:"–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö", selectModels:"–í–∏–±–µ—Ä—ñ—Ç—å —Ö–æ—á–∞ –± 2 –º–æ–¥–µ–ª—ñ"
  }
};

function applyLang(){
  const lang=langSelect.value;
  document.getElementById("title").textContent=t[lang].title;
  document.getElementById("subtitle").textContent=t[lang].subtitle;
  document.getElementById("sortHeading").textContent=t[lang].sortHeading;
  document.getElementById("sortName").textContent=t[lang].sortName;
  document.getElementById("sortDesc").textContent=t[lang].sortDesc;
  document.getElementById("sortAsc").textContent=t[lang].sortAsc;
  document.getElementById("modelsHeading").textContent=t[lang].modelsHeading;
  document.getElementById("metricHeading").textContent=t[lang].metricHeading;
  document.getElementById("metricMin").textContent=t[lang].metricMin;
  document.getElementById("metricAvg").textContent=t[lang].metricAvg;
  document.getElementById("metricMax").textContent=t[lang].metricMax;
  document.getElementById("chartHeading").textContent=t[lang].chartHeading;
  document.getElementById("chartContainer").textContent=t[lang].chartContainer;

  // –æ–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–¥–ø–∏—Å–∏ –≤ —Å–ø–∏—Å–∫–µ –º–æ–¥–µ–ª–µ–π
  document.querySelectorAll("#modelContainer small").forEach(el => {
	const count = el.dataset.count;
	el.textContent = `(${t[langSelect.value].testCount}: ${count})`;
  });
}


// ===== LOCAL STORAGE =====
function savePrefs() {
  const models = getSelectedModels();
  const theme = document.body.classList.contains("light") ? "light" : "dark";
  const lang = langSelect.value;
  const metric = metricGroup.querySelector("input:checked")?.value || "avg";

  localStorage.setItem("theme", theme);
  localStorage.setItem("lang", lang);
  localStorage.setItem("metric", metric);
  localStorage.setItem("models", JSON.stringify(models));

  console.log("[savePrefs]", { theme, lang, metric, models });
}

function loadPrefs() {
  // ===== Theme =====
  const theme = localStorage.getItem("theme");
  if (theme) {
    document.body.classList.remove("light", "dark");
    document.body.classList.add(theme);
    themeToggle.textContent = theme === "light" ? "‚òÄÔ∏è" : "üåô";
  }

  // ===== Language =====
  let lang = localStorage.getItem("lang");
  if (!lang) {
    lang = (navigator.language || "en").substring(0, 2);
    if (!["en", "ru", "uk"].includes(lang)) lang = "en";
    localStorage.setItem("lang", lang);
  }
  langSelect.value = lang;
  applyLang();

  // ===== Metric =====
  const metric = localStorage.getItem("metric");
  if (metric) {
    const radio = metricGroup.querySelector(`input[value="${metric}"]`);
    if (radio) radio.checked = true;
  }

  // ===== Models =====
  const savedModels = JSON.parse(localStorage.getItem("models") || "[]");

  console.log("[loadPrefs]", { theme, lang, metric, savedModels });

  return { theme, lang, metric, savedModels };
}

// ===== THEME =====
themeToggle.addEventListener("click",()=>{
  document.body.classList.toggle("light");
  document.body.classList.toggle("dark");
  themeToggle.textContent=document.body.classList.contains("light")?"‚òÄÔ∏è":"üåô";
  savePrefs();
  if(chart) {chart.update(); refreshChart();}
});

// ===== INIT =====
const prefs = loadPrefs();  // —Å–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

// ===== MODELS =====
async function loadModels(){
  chartContainer.textContent=t[langSelect.value].chartContainer;
  const res=await fetch(BASE+"?modelsOnly=true");
  const j=await res.json();
  let models=j.models||[];

  const sortVal=sortGroup.querySelector("input:checked").value;
  if(sortVal==="name") models.sort((a,b)=>a.name.localeCompare(b.name));
  if(sortVal==="countDesc") models.sort((a,b)=>b.count-a.count);
  if(sortVal==="countAsc") models.sort((a,b)=>a.count-b.count);

  modelContainer.innerHTML="";
  models.forEach(({name,count})=>{
    const lbl=document.createElement("label");
    const chk=document.createElement("input");
    chk.type="checkbox"; chk.value=name;
    lbl.appendChild(chk);
    const wrap=document.createElement("div");
    const span=document.createElement("span");
    span.textContent=name;
    const small=document.createElement("small");
	small.dataset.count = count; // —Å–æ—Ö—Ä–∞–Ω—è–µ–º —á–∏—Å–ª–æ —Ç–µ—Å—Ç–æ–≤ –æ—Ç–¥–µ–ª—å–Ω–æ
    small.textContent=`(${t[langSelect.value].testCount}: ${count})`;
    wrap.appendChild(span);
    wrap.appendChild(small);
    lbl.appendChild(wrap);
    modelContainer.appendChild(lbl);
  });

  const boxes=modelContainer.querySelectorAll("input[type=checkbox]");
  if(boxes.length){
    boxes[0].checked=true;
    boxes.forEach(b=>{if(b.value==="Balance 2") b.checked=true;});
  }

  refreshChart();
}

function getSelectedModels(){
  return Array.from(modelContainer.querySelectorAll("input:checked")).map(c=>c.value).slice(0,6);
}

async function fetchModelStats(model){
  if(cache[model]) return cache[model];
  const res=await fetch(BASE+"?deviceName="+encodeURIComponent(model));
  const j=await res.json();
  const s=j.stats&&j.stats[model];
  cache[model]=s||null;
  return cache[model];
}

// ===== CHART =====
async function refreshChart(){
  const models=getSelectedModels();
  if(models.length<2){
	chartContainer.textContent=t[langSelect.value].selectModels;
	return;
  }
  chartContainer.textContent=t[langSelect.value].chartContainer;

  const metric=metricGroup.querySelector("input:checked").value;
  const keys=["canvas","canvasText","widget","widget2","math","ls","es","esBf"];
  const labels=labelTranslations[langSelect.value]||labelTranslations.en;

  const lightColors=["#1565c0","#ad1457","#ef6c00","#2e7d32","#c2185b","#6a1b9a","#0277bd","#d84315"];
  const darkColors=["#42a5f5","#f06292","#ffb74d","#81c784","#f48fb1","#ba68c8","#64b5f6","#ff8a65"];
  const colors=document.body.classList.contains("light")?lightColors:darkColors;

  const dataByModel={};
  for(const model of models){
    const stats=await fetchModelStats(model);
    if(!stats) continue;
    dataByModel[model]=keys.map(k=>stats[k]?stats[k][metric]:0);
  }

  const modelNames=Object.keys(dataByModel);
  if(!modelNames.length){
	chartContainer.textContent=t[langSelect.value].noData;
	return;
  }

  const maxPerKey=keys.map((_,i)=>Math.max(...modelNames.map(m=>dataByModel[m][i]||0)));
  const normalizedByModel={};
  modelNames.forEach(m=>{
    normalizedByModel[m]=dataByModel[m].map((v,i)=>maxPerKey[i]?v/maxPerKey[i]*100:0);
  });

  const datasets=modelNames.map((m,i)=>({
    label:m,
    data:normalizedByModel[m],
    backgroundColor:colors[i%colors.length],
    //barThickness:18
	//barThickness:"flex"
  }));

  //const groupFactor=Math.max(0.8,1-models.length*0.08);
  //console.log("groupFactor: ", groupFactor);

    const numKeys = 8; // —á–∏—Å–ª–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π/–∫–ª—é—á–µ–π
    const barHeight = 8; // –≤—ã—Å–æ—Ç–∞ –∫–∞–∂–¥–æ–π –ø–æ–ª–æ—Å—ã –≤ px
    const gapBetweenModels = 6; // —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –Ω–∞–±–æ—Ä–∞–º–∏ –ø–æ–ª–æ—Å

    const totalHeight = numKeys * models.length * (barHeight + gapBetweenModels);

    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ canvas
    chartContainer.innerHTML = '<canvas id="chart"></canvas>';
    const canvas = document.getElementById("chart");
    canvas.height = totalHeight; // –∑–∞–¥–∞—ë–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫—É—é –≤—ã—Å–æ—Ç—É
    const ctx = canvas.getContext("2d");

  //chartContainer.innerHTML='<canvas id="chart"></canvas>';
  //const ctx=document.getElementById("chart").getContext("2d");
  if(chart) chart.destroy();
  chart=new Chart(ctx,{
	  type:"bar",
	  data:{labels:labels,datasets:datasets},
	  options:{
		indexAxis:"y",
		responsive:true,
		plugins:{
		  legend:{position:"bottom"},
		  tooltip:{
			callbacks:{
			  label:(ctx)=>{
				const v=ctx.raw;
				return v.toFixed(1)+"%";
			  }
			}
		  },
		  datalabels:{
			  anchor:"end",       // —Ç–µ–∫—Å—Ç —Å–ø—Ä–∞–≤–∞ –æ—Ç –ø–æ–ª–æ—Å—ã
			  align:"right",      // —Å–ø—Ä–∞–≤–∞ –æ—Ç –ø–æ–ª–æ—Å—ã
			  color:document.body.classList.contains("light")?"#000":"#fff",
			  formatter:(v, ctx)=>{
				// –ë–µ—Ä–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ dataByModel, –Ω–µ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ
				const model = ctx.dataset.label;
				const index = ctx.dataIndex;
				const key = keys[index];
				const originalValue = dataByModel[model][index] || 0;
				return originalValue;
			  }
			}
		},
		scales:{
		  x:{
			beginAtZero:true,
			max:110, // –æ—Å—Ç–∞–≤–ª—è–µ–º –º–µ—Å—Ç–æ –¥–ª—è –ø–æ–¥–ø–∏—Å–µ–π
			ticks:{display:false}
		  },
		  y:{
			//categoryPercentage: 0.2, // —à–∏—Ä–∏–Ω–∞ –≥—Ä—É–ø–ø—ã
			//barPercentage: 0.2,       // —à–∏—Ä–∏–Ω–∞ –∫–∞–∂–¥–æ–π –ø–æ–ª–æ—Å—ã
			ticks:{
			  callback:function(value,index){
				const label=this.getLabelForValue(value);
				// –†–∞–∑–±–∏–≤–∞–µ–º –¥–ª–∏–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∏ –Ω–∞ —Å—Ç—Ä–æ–∫–∏ —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª—ã
				const maxLineLength = 20; // —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ —Å—Ç—Ä–æ–∫—É
				if(label.length > maxLineLength){
				  let result = [];
				  let words = label.split(" ");
				  let line = "";
				  for(const w of words){
					if((line+w).length > maxLineLength){
					  result.push(line.trim());
					  line = w + " ";
					} else {
					  line += w + " ";
					}
				  }
				  result.push(line.trim());
				  return result; // –º–∞—Å—Å–∏–≤ = –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫
				}
				return label;
			  }
			}
		  }
		}
	  },
	  plugins:[ChartDataLabels]
	});

}

// ===== EVENTS =====
sortGroup.addEventListener("change",()=>{loadModels();});
metricGroup.addEventListener("change",()=>{refreshChart();});
modelContainer.addEventListener("change",()=>{refreshChart();});
langSelect.addEventListener("change",()=>{applyLang(); savePrefs(); refreshChart();});

// ===== INIT =====
loadModels();
</script>
</body>
</html>
